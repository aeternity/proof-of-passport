include "List.aes"
include "BLS12_381.aes"

contract Verifier =
  record proof = {a : BLS12_381.g1, b : BLS12_381.g2, c : BLS12_381.g1}
  record proofInput = {a : int * int, b : (int * int) * (int * int), c : int * int}
  record verifying_key = {alpha : BLS12_381.g1, beta : BLS12_381.g2, gamma : BLS12_381.g2,
                          delta : BLS12_381.g2, gamma_abc : list(BLS12_381.g1)}

  entrypoint verify(input : list(int), proof_in : proofInput) : bool =
    verify_(input, mk_proof(proof_in))

  entrypoint verify_(input : list(int), proof : proof) : bool =
    let snark_scalar_field = 0x73eda753299d7d483339d80809a1d80553bda402fffe5bfeffffffff00000001
    let vk = verifying_key()
    require(List.length(input) + 1 == List.length(vk.gamma_abc), "invalid input")
    [ require(i =< snark_scalar_field, "invalid input") | i <- input ]
    let (g0 :: gs) = vk.gamma_abc
    let vk_x = List.foldl(addAndScalarMul, g0, List.zip(input, gs))
    BLS12_381.pairing_check([proof.a, BLS12_381.g1_neg(vk_x), BLS12_381.g1_neg(proof.c), BLS12_381.g1_neg(vk.alpha)],
                            [proof.b, vk.gamma, vk.delta, vk.beta])

  private function addAndScalarMul(x : BLS12_381.g1, (i, g) : int * BLS12_381.g1) =
    BLS12_381.g1_add(x, BLS12_381.g1_mul(BLS12_381.int_to_fr(i), g))

  private function mk_proof({a = (ax, ay), b = ((bx1, bx2), (by1, by2)), c = (cx, cy)} : proofInput) : proof =
    {a = BLS12_381.mk_g1(ax, ay, 1),
     b = BLS12_381.mk_g2(bx1, bx2, by1, by2, 1, 0),
     c = BLS12_381.mk_g1(cx, cy, 1)}

  private function verifying_key() : verifying_key =
    {
      alpha = BLS12_381.mk_g1(444687880216625946393860482731527953039470237592824500046901643605082720072412474812608718099600374464983996929719,
                              1420878895307173979990339328004536671272441326902852150624254464527733754776962633197033561590470701642175463625996,
                              1),
      beta = BLS12_381.mk_g2(1205153757335645695416304361664830533575010710700369912092225203123409049425457692728841637654255424963764087101636,
                             216545429637786920749103158733449085855685268440704668822516427407764451775365663634865704724973873604926462033069,
                             3999936856952763702742976236069429667724902544882693136161729895070621804575055816795288362380769162395490785026255,
                             1887328905820092225613232142348394677038562405524366257170207590772157135048229731518316820932790511865832469546194,
                             1, 0),
      gamma = BLS12_381.mk_g2(352701069587466618187139116011060144890029952792775240219908644239793785735715026873347600343865175952761926303160,
                              3059144344244213709971259814753781636986470325476647558659373206291635324768958432433509563104347017837885763365758,
                              1985150602287291935568054521177171638300868978215655730859378665066344726373823718423869104263333984641494340347905,
                              927553665492332455747201965776037880757740193453592970025027978793976877002675564980949289727957565575433344219582,
                              1, 0),
      delta = BLS12_381.mk_g2(352701069587466618187139116011060144890029952792775240219908644239793785735715026873347600343865175952761926303160,
                              3059144344244213709971259814753781636986470325476647558659373206291635324768958432433509563104347017837885763365758,
                              1985150602287291935568054521177171638300868978215655730859378665066344726373823718423869104263333984641494340347905,
                              927553665492332455747201965776037880757740193453592970025027978793976877002675564980949289727957565575433344219582,
                              1, 0),
      gamma_abc =
        [
          BLS12_381.mk_g1(1969595432356241917667401642903786835444257226916248568928353296201864810163692147078802396485717787564389566861605,
                          2026017481704082918456303533044038587549868029853627047213324530580153320387266527175622574666724391192127655393183,
                          1),
          BLS12_381.mk_g1(790091996277566162336092241174525574079773266167806280955790554334717523351166712836995085770578761721165298479314,
                          70380903025907200992710515066006888662654524384046484057871641056920478936136597710816399109167053981431149007334,
                          1),
          BLS12_381.mk_g1(311978126926174292322731400945467896856303607671655047327187406664104810657829047868454154416875036927630305063070,
                          2088621020277107045249384041163243826712770640253279777301456423746475997890249491072788337852213385691611606055256,
                          1),
          BLS12_381.mk_g1(3637559394395033362434167612860569718835758754430745146562041249719955258200784270046364704728628192781072017813196,
                          1043000848979468704276178664627242323987960466634640280136645887691525938608036841247150197244649086233841724860347,
                          1),
          BLS12_381.mk_g1(1335782084296479245356301007177050797276152383752832402071985973119554895906245122503757625035174561127063254151722,
                          3927026421260677325158338010499536871910221787451016224269960083385615749605909561407722972555392915849622480289994,
                          1),
          BLS12_381.mk_g1(3107989392017291401028843005155794095855049319072405931867255657817970249429906981406262751950258388420613487891386,
                          728823391264815085270557389690500319913413798422084371475660851660443584520376781092123022482110867720635763414200,
                          1),
          BLS12_381.mk_g1(2269426193286340845379827057203332657052482785851494777861178201054323561223393420434522573215152714838938383283636,
                          663530716968755739231767699660510362951299833792417079310287511112120077114301592946144602980632242321592878604825,
                          1),
          BLS12_381.mk_g1(1769715843647466964813162108104227588393904033093694335159722267506345955690341386902598996901905494273493618913851,
                          3333713237722782780280496734820369124543994803236670956901927439267755070427877841620815012171353727946086545719506,
                          1),
          BLS12_381.mk_g1(3467976342211919524947508446332568809432883493044825988517641489817740549082480865566112228049120965433485303855296,
                          3238009294967090560102027068988764729760580292575865736557920080285085960377876722458600998471317691557491660700948,
                          1),
          BLS12_381.mk_g1(3280280809861637576448804139739115692230383793435983548264046848169607856296014301747653468679161081589979371920926,
                          2218578275326167220893854744221854837088587455975029432898938848360165186189724502102087608302031793333204170096423,
                          1),
          BLS12_381.mk_g1(3417574033609584303003900899410922143062707127500102034392962465089853166891015370390678054442529168352415754605294,
                          2717394926909053294174829013293499973642559969989252387904045679050598248948625185998224905386726962129914308038738,
                          1),
          BLS12_381.mk_g1(48195183222862040917271770527558604505631868666829901393396185914410854155105643790514256380774311242869682009814,
                          2655361834375986132466988755554099263924287668502138472396038995490084303768558998510815710304753861757214200085002,
                          1),
          BLS12_381.mk_g1(1830932403533046277681524438818756369636927706712662071321463292200775417283651108326076467332528730534836364807500,
                          3851504550347836882054570840177231269431016450928085682692177893712883775206340144048081833294106614430177220898021,
                          1),
          BLS12_381.mk_g1(3414640721292123762257889655855456675764493639008777140997862734287697415318919489689153413348850390493242373752164,
                          3309221649202297689405788094209668022150797101962111548444242002087287138397072340849400459551881116401473319491966,
                          1),
          BLS12_381.mk_g1(6874854011314393436196399112472318259869309910042986999459562751468658561586505074387814897635655770231180231549,
                          3114147019918522441848763467783472059037434472466173780130813109090725422136673856405601155596008747445877106787051,
                          1),
          BLS12_381.mk_g1(710234334522694097735873579376643490518548647434889357239723601421150709942697957617333667080730438331367684623454,
                          1631783375629447378232487934093050499760567335442822232405090245384708313084074759089784600115311059769822673493368,
                          1),
          BLS12_381.mk_g1(2648898455053946540553743944532186156263307812321373011008704745746074876774918022431720066456094741514181584328982,
                          2153612362703310469303612216467862625543929186760906324506069667789800979685077093749329619936410671579759312242854,
                          1)
        ] }

  entrypoint the_proof() : proof = {
      a = BLS12_381.mk_g1(1103464000801227368203346784575637509089389137915874130508804730187256741145212073774597454358638005171830320714480,
                          857757293422883643557420303309864029064478047705359437463428236781456991837193952390970779381462121359967679820407,
                          1),
      b = BLS12_381.mk_g2(161865699492737311453717826023955490371343595855981751671015812296701763564315537212196630911741311434744586507291,
                          2688447833646793628185566783384099079075698769870986277754481224578043186551209082214691804038298611407942609081219,
                          1213404974150357513592070428774803647958542954176937518095165714595849727720260258336639813593724537524518883519328,
                          1041009625456683461125273341208536409030977934812320788741282470344641079136272905734384387797406753110479226507561,
                          1, 0),
      c = BLS12_381.mk_g1(1358142297876751249632802393200558585073399748921417093617398536627437612990499741326273817189537182858253391366638,
                          1130030892960576760376791626958218108004035891214052081877773237846643731443795920950575485473907654956460487311210,
                          1)
    }

  entrypoint test(input: list(int)) =
    verify_(input, the_proof())